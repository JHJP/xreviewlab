{% extends "base.html" %}

{% block content %}
  <h1 style="margin-bottom:0.3em;">{{ product_name }}</h1>
  <p class="tagline">고객의 소리 대응 서포터</p>

  <div style="text-align:center; margin-bottom:1.5rem; position:relative;">
    {% if wordcloud_url and histogram_url %}
      <div class="chart-img-container" style="position:relative; display:inline-block; min-height:220px;">
        <div class="toggle-switch-wrap" style="position:absolute; bottom:100%; right:0; z-index:20; display:flex; align-items:center; gap:6px; transform:translateY(-18px);">
          <label class="toggle-switch" style="margin:0;">
            <input type="checkbox" id="toggle-chart-switch">
            <span class="slider">
              <span class="toggle-on">ON</span>
              <span class="toggle-off">OFF</span>
            </span>
          </label>
          <span id="chart-help" style="cursor:pointer; display:inline-flex; align-items:center; margin-left:3px;">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="10" cy="10" r="8.5" stroke="#888" stroke-width="1.6" fill="white"/>
              <text x="10" y="14" text-anchor="middle" font-size="12" font-family="Arial" fill="#888">?</text>
            </svg>
            <span id="chart-tooltip" style="display:none; position:absolute; top:28px; right:-10px; background:#fff; color:#333; border:1px solid #d0d7de; border-radius:8px; padding:0.7em 1.1em; font-size:0.97em; box-shadow:0 4px 18px rgba(0,0,0,.10); white-space:nowrap; z-index:10; min-width:220px;">
              OFF(워드클라우드): 버튼을 ON으로 바꾸면 키워드 히스토그램이 표시됩니다.
            </span>
          </span>
        </div>
        <img id="wordcloud-img" src="{{ wordcloud_url }}" alt="워드클라우드" style="max-width:100%; height:auto; display:block; margin:auto;">
        <img id="histogram-img" src="{{ histogram_url }}" alt="키워드 히스토그램" style="max-width:100%; height:auto; display:none; margin:auto;">
      </div>
      <div id="chart-label" style="font-size:0.95em; color:#888; margin-top:0.2em;">키워드 워드클라우드</div>
      <style>
        .toggle-switch {
          position: relative;
          display: inline-block;
          width: 54px;
          height: 28px;
        }
        .toggle-switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0; left: 0; right: 0; bottom: 0;
          background-color: #e3eaf6;
          border-radius: 28px;
          transition: .3s;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 22px;
          width: 22px;
          left: 4px;
          bottom: 3px;
          background-color: #fff;
          border-radius: 50%;
          transition: .3s;
          box-shadow: 0 1px 4px rgba(0,0,0,.10);
        }
        .toggle-switch input:checked + .slider {
          background-color: var(--clr-indigo, #5C3BFF);
        }
        .toggle-switch input:checked + .slider:before {
          transform: translateX(26px);
        }
        .toggle-switch .slider {
          box-shadow: 0 1px 4px rgba(0,0,0,.10);
        }
      </style>
      <script>
        const helpIcon = document.getElementById('chart-help');
        const tooltip = document.getElementById('chart-tooltip');
        const toggleSwitch = document.getElementById('toggle-chart-switch');
        const wordcloudImg = document.getElementById('wordcloud-img');
        const histogramImg = document.getElementById('histogram-img');
        const chartLabel = document.getElementById('chart-label');
        const slider = document.querySelector('.slider');

        function updateTooltipText(isOn) {
          tooltip.textContent = isOn
            ? 'ON(히스토그램): 버튼을 OFF로 바꾸면 워드클라우드가 표시됩니다.'
            : 'OFF(워드클라우드): 버튼을 ON으로 바꾸면 키워드 히스토그램이 표시됩니다.';
        }
        function updateChart(isOn) {
          if (isOn) {
            wordcloudImg.style.display = 'none';
            histogramImg.style.display = 'block';
            chartLabel.textContent = '키워드 히스토그램';
            slider.setAttribute('data-state', 'ON');
          } else {
            wordcloudImg.style.display = 'block';
            histogramImg.style.display = 'none';
            chartLabel.textContent = '키워드 워드클라우드';
            slider.setAttribute('data-state', 'OFF');
          }
        }
        toggleSwitch.checked = false;
        updateTooltipText(false);
        updateChart(false);

        toggleSwitch.addEventListener('change', function() {
          updateTooltipText(this.checked);
          updateChart(this.checked);
        });
        helpIcon.addEventListener('mouseenter', () => { tooltip.style.display = 'block'; });
        helpIcon.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; });
      </script>
      <style>
        .toggle-switch {
          position: relative;
          display: inline-block;
          width: 54px;
          height: 28px;
        }
        .toggle-switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0; left: 0; right: 0; bottom: 0;
          background-color: #e3eaf6;
          border-radius: 28px;
          transition: .3s;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 22px;
          width: 22px;
          left: 4px;
          bottom: 3px;
          background-color: #fff;
          border-radius: 50%;
          transition: .3s;
          box-shadow: 0 1px 4px rgba(0,0,0,.10);
        }
        .slider .toggle-on,
        .slider .toggle-off {
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
          font-size: 10px;
          font-weight: normal;
          color: #fff;
          pointer-events: none;
          transition: opacity .3s;
          letter-spacing: 0.5px;
        }
        .slider .toggle-on {
          left: 9px;
          width: 22px;
          height: 100%;
          display: flex;
          align-items: center;
          text-align: left;
          opacity: 0;
        }
        .slider .toggle-off {
          right: 4px;
          width: 22px;
          height: 100%;
          display: flex;
          align-items: center;
          text-align: right;
          opacity: 1;
        }
        .toggle-switch input:checked + .slider .toggle-on {
          opacity: 1;
        }
        .toggle-switch input:checked + .slider .toggle-off {
          opacity: 0;
        }
        .toggle-switch input:checked + .slider {
          background-color: var(--clr-indigo, #5C3BFF);
        }
        .toggle-switch input:checked + .slider:before {
          transform: translateX(26px);
        }
        .toggle-switch .slider {
          box-shadow: 0 1px 4px rgba(0,0,0,.10);
        }
      </style>
    {% elif wordcloud_url %}
      <img src="{{ wordcloud_url }}" alt="워드클라우드" style="max-width:100%; height:auto;">
      <div style="font-size:0.95em; color:#888; margin-top:0.2em;">키워드 워드클라우드</div>
    {% else %}
      <div style="font-size:0.95em; color:#888; margin-top:0.2em;">키워드가 없습니다.</div>
    {% endif %}
  </div>

  <table class="voc-table" style="width:100%; border-collapse:collapse;">
    <thead>
      <tr style="background:#f2f2f2;">
        <th style="padding:0.7em; border:1px solid #ddd;">닉네임</th>
        <th style="padding:0.7em; border:1px solid #ddd;">업로드 날짜</th>
        <th style="padding:0.7em; border:1px solid #ddd;">리뷰 장소</th>
        <th style="padding:0.7em; border:1px solid #ddd;">위험수치</th>
        <th style="padding:0.7em; border:1px solid #ddd;">별점</th>
        <th style="padding:0.7em; border:1px solid #ddd;">도움돼요 수</th>
        <th style="padding:0.7em; border:1px solid #ddd;">리뷰 내용</th>
      </tr>
    </thead>
    <tbody>
      {% for r in reviews %}
      <tr>
        <td style="padding:0.7em; border:1px solid #ddd;">{{ r.nickname }}</td>
        <td style="padding:0.7em; border:1px solid #ddd;">{{ r.date }}</td>
        <td style="padding:0.7em; border:1px solid #ddd;">
          <a href="{{ product_link }}" target="_blank">올리브영</a>
        </td>
        <td style="padding:0.7em; border:1px solid #ddd; color:#bbb;">추후 예정</td>
        <td style="padding:0.7em; border:1px solid #ddd;">{{ r.score }}</td>
        <td style="padding:0.7em; border:1px solid #ddd;">{{ r.help_cnt }}</td>
        <td style="padding:0.7em; border:1px solid #ddd;">{{ r.content }}</td>
      </tr>
      <tr>
        <td colspan="7" style="padding:0.4em 0.7em; border:1px solid #ddd; background:#fafafa; color:#888; font-size:0.97em; text-align:left;">
          <span style="font-style:italic;">불평 키워드: {{ r.keywords_str if r.keywords_str else '키워드 없음' }}</span>
        </td>
      </tr>
      <tr>
        <td colspan="7" style="padding:0.4em 0.7em; border:1px solid #ddd; background:#f6fffa; text-align:left;">
          <button type="button" class="auto-reply-btn" data-review-content="{{ r.content|e }}" style="padding:0.35em 1.1em; border-radius:6px; border:1px solid #2ED47A; background:#2ED47A; color:#fff; font-size:0.96em; font-weight:600; cursor:pointer;">자동응답 생성</button>
          <span class="auto-reply-result" style="margin-left:1.2em; color:#3b3b3b; font-size:0.97em;"></span>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% if reviews|length == 0 %}
    <div style="text-align:center; color:#888; margin-top:2em;">리뷰가 없습니다.</div>
  {% endif %}
  <div style="margin-top:2em;">
    <a href="{{ url_for('index') }}" class="banner-btn">← 상품 목록으로 돌아가기</a>
  </div>
  <script src="{{ url_for('static', filename='auto_reply.js') }}"></script>
{% endblock %}
