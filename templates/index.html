{# templates/index.html #}
{% extends "base.html" %}

{# ëŒ€ì‘ ë°©ë²• í•œê¸€ ë¼ë²¨ ë§¤í•‘ -------------------------------------- #}
{% set method_labels = {
  'text_reply'     : 'ëŒ“ê¸€ë¡œ ë‹µì¥',
  'chat_followup'  : 'ì±„íŒ…ë°© ë‹µì¥',
  'phone_call'     : 'ì „í™”í•˜ê¸°',
  'discount_coupon': 'ì¿ í° ë³´ë‚´ê¸°',
  'vip_apology'    : 'VIP ì‚¬ê³¼'
} %}

{% block content %}

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     A.  ì²« í™”ë©´ / ì˜¨ë³´ë”© ì˜¤ë²„ë ˆì´
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="welcome-overlay" class="overlay"
     {% if not tutorial_mode %}style="display:none"{% endif %}>
  <div class="overlay-card">
    <h1>ì—‘ìŠ¤ ë¦¬ë·° ë©ì— ì˜¤ì‹  ê±¸<br> í™˜ì˜í•´ìš” ğŸ‘‹</h1>
    <p>
      ìš°ë¦¬ ì„œë¹„ìŠ¤ëŠ” <strong>ê³ ê°ì˜ ì†Œë¦¬(VoC)</strong>ê°€ <br>
      <strong>ìƒì‚°ê³µì •</strong>ì— ë°˜ì˜ë˜ëŠ” íš¨ìœ¨ì„ ë†’ì—¬ì¤˜ìš”.<br>
      ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´<br> <strong>3ë¶„</strong> ë§Œì— <strong>ìƒ˜í”Œ</strong> í™”ë©´ì„ ë³¼ ìˆ˜ ìˆì–´ìš”!
    </p>
    <button id="startTutorialBtn">ì‹œì‘í•˜ê¸°</button>
  </div>
</div>

<h1>ê³ ê°ì˜ ì†Œë¦¬ ëŒ€ì‘ ì„œí¬í„°</h1>
<p class="tagline">AIê°€ <strong>ê°€ì¥ ì¤‘ìš”í•œ ê³ ê°ì˜ ì†Œë¦¬</strong>ë¶€í„° í•´ê²°í•©ë‹ˆë‹¤.</p>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     B.  ì…ë ¥ ì¹´ë“œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="card">
  <form method="POST" enctype="multipart/form-data" id="plannerForm">
    <label for="brand_name">ë¸Œëœë“œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</label>
    <input type="text" name="brand_name" id="brand_name" placeholder="ì˜ˆ: í† ë¦¬ë“ " required>

    <label for="brand_url">ìì‚¬ëª° URLì„ ì…ë ¥í•˜ì„¸ìš”</label>
    <input type="text" name="brand_url" id="brand_url" placeholder="ì˜ˆ: https://www.torriden.com/" required>

    <button type="button" id="vocListenBtn">VoC ë“£ê¸°</button>
    <div id="loading-spinner" style="display:none; text-align:center; margin-top:1em;">
      <div class="spinner" style="display:inline-block; width:40px; height:40px; border:4px solid #eee; border-top:4px solid #22b86b; border-radius:50%; animation:spin 1s linear infinite;"></div>
      <div style="margin-top:0.5em; color:#22b86b; font-weight:600;">ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    <style>
      @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    </style>
    <script>
      document.getElementById('vocListenBtn').addEventListener('click', function() {
        document.getElementById('loading-spinner').style.display = '';
        const brandName = document.getElementById('brand_name').value;
        const brandUrl = document.getElementById('brand_url').value;
        fetch('/voc_listen', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: new URLSearchParams({
            brand_name: brandName,
            brand_url: brandUrl
          })
        }).then(resp => {
          if (resp.redirected) {
            window.location.href = resp.url;
          } else {
            window.location.reload();
          }
        });
      });
    </script>
  </form>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     C.  ROI ëŒ€ì‹œë³´ë“œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
{% if products %}
  <h2 style="margin:2rem 0 1rem;">ìƒí’ˆë³„ VoC ìš”ì•½</h2>
  <table class="voc-table" style="width:100%; border-collapse:collapse;">
    <thead>
      <tr style="background:#f2f2f2;">
        <th style="padding:0.7em; border:1px solid #ddd;">ìƒí’ˆëª…</th>
        <th style="padding:0.7em; border:1px solid #ddd;">ë³„ì </th>
        <th style="padding:0.7em; border:1px solid #ddd;">ìœ„í—˜ìˆ˜ì¹˜</th>

      </tr>
    </thead>
    <tbody>
      {% for p in products %}
      <tr>
        <td style="padding:0.7em; border:1px solid #ddd;">
          {% set has_reviews = p.goodsNo is defined and p.goodsNo %}
          {% if has_reviews %}
            <a href="/product/{{ p.goodsNo }}/reviews" style="color:#2ED47A; font-weight:600; text-decoration:underline;">{{ p.name }}</a>
          {% else %}
            <span style="color:#bbb; cursor:not-allowed;">{{ p.name }}</span>
          {% endif %}
        </td>
        <td style="padding:0.7em; border:1px solid #ddd;">{{ p.rating }}</td>
        <td style="padding:0.7em; border:1px solid #ddd;">{{ p.damage_sum if p.damage_sum is not none else '-' }}</td>

      </tr>
      <tr>
        <td colspan="3" style="padding:0.7em; border:1px solid #ddd;">ì¶”í›„ ì˜ˆì •</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     D.  ì¶”ì²œ ì•¡ì…˜ í…Œì´ë¸”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
{% if recommended_responses %}
  <!-- ì›Œë“œí´ë¼ìš°ë“œ ì•ˆë‚´ ë° í‘œì‹œ -->
  <div style="margin-top:2.2rem; margin-bottom:0.2rem;">
    <div style="font-size:0.97em; color:#666; margin-bottom:0.35em; text-align:center;">
      ì•„ë˜ ì›Œë“œí´ë¼ìš°ë“œëŠ” ìµœê·¼ ë¦¬ë·°ì—ì„œ ìì£¼ ì–¸ê¸‰ëœ ì£¼ìš” í‚¤ì›Œë“œë¥¼ ì‹œê°í™”í•œ ê²ƒì…ë‹ˆë‹¤.<br>
      ë‹¨ì–´ê°€ í´ìˆ˜ë¡ ë” ë§ì´ ì–¸ê¸‰ëœ ì˜ë¯¸ì…ë‹ˆë‹¤.
    </div>
    <div id="wordCloud" style="width:100%; height:260px; margin-bottom:1.4rem;"></div>
  </div>
  <h2 style="margin-top:1.3rem;">ì¶”ì²œ ì¡°ì¹˜</h2>
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem; gap:1.5em;">
    <a href="/download_report" class="banner-btn" style="padding:0.5em 1.2em; font-size:0.98em;">ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ (ì—‘ì…€)</a>
    <form id="emailReportForm" method="POST" action="/send_report_email" style="display:flex; align-items:center; gap:0.5em;">
      <input type="email" name="email" placeholder="ì´ë©”ì¼ ì…ë ¥" required style="padding:0.45em 0.8em; border-radius:7px; border:1px solid #ccc; font-size:0.97em;">
      <button type="submit" class="banner-btn" style="padding:0.5em 1.2em; font-size:0.98em; background:#2ED47A;">ì´ë©”ì¼ë¡œ ë¦¬í¬íŠ¸ ë°œì†¡</button>
    </form>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
  <script>
    document.getElementById('emailReportForm').onsubmit = async function(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const res = await fetch(form.action, {
        method: 'POST',
        body: formData
      });
      const text = await res.text();
      alert(text);
    };
  </script>
  {% if wordcloud_url %}
    <div style="text-align:center; margin-bottom:1.5rem;">
      <img src="{{ wordcloud_url }}" alt="ì›Œë“œí´ë¼ìš°ë“œ" style="max-width:100%; height:auto;">
      <div style="font-size:0.95em; color:#888; margin-top:0.2em;">ì „ì²´ ë¦¬ë·° í‚¤ì›Œë“œ ìš”ì•½</div>
    </div>
  {% endif %}
  <!-- ì¶”ì²œ ì¡°ì¹˜ë³„(ëŒ€ì‘ ë°©ë²•ë³„) í•„í„° ë“œë¡­ë‹¤ìš´ -->
  <div class="filter-bar" style="display:flex; flex-wrap:wrap; gap:1.5em; align-items:center; margin-bottom:1.2em;">
    <label for="methodFilter" style="font-weight:600; margin-right:0.5em;">ëŒ€ì‘ ë°©ë²•</label>
    <select id="methodFilter" style="min-width:110px; padding:0.4em 1.2em; border-radius:6px; border:1px solid #bbb; font-size:1em;">
      <option value="all">ì „ì²´</option>
      {% for m in methods %}
        <option value="{{ m }}">{{ method_labels[m] }}</option>
      {% endfor %}
    </select>
    <label for="categoryFilter" style="font-weight:600; margin-left:1.5em; margin-right:0.5em;">ì¹´í…Œê³ ë¦¬</label>
    <select id="categoryFilter" style="min-width:90px; padding:0.4em 1.2em; border-radius:6px; border:1px solid #bbb; font-size:1em;">
      <option value="all">ì „ì²´</option>
      <option value="í’ˆì§ˆ">í’ˆì§ˆ</option>
      <option value="ê°€ê²©">ê°€ê²©</option>
      <option value="ì„œë¹„ìŠ¤">ì„œë¹„ìŠ¤</option>
      <option value="ê¸°íƒ€">ê¸°íƒ€</option>
    </select>
    <button type="button" id="resetFiltersBtn" class="reset-btn">í•„í„° ì´ˆê¸°í™”</button>
    <style>
      .reset-btn {
        margin-left:1.5em;
        padding:0.35em 1em;
        border-radius:6px;
        border:1px solid #2ED47A;
        background:#2ED47A;
        color:#fff;
        font-size:0.97em;
        font-weight:600;
        cursor:pointer;
        transition: background 0.18s, color 0.18s;
      }
      .reset-btn:hover, .reset-btn:focus {
        background:#22b86b;
        color:#fff;
        border-color:#22b86b;
      }
    </style>
  </div>
  <table id="recommendTable">
    <thead>
      <tr>
        <th style="width:110px; cursor:pointer" id="dateSortHeader">ë‚ ì§œ <span id="dateSortIcon">â–¼</span></th>
        <th style="width:88px; cursor:pointer" id="riskSortHeader">ìœ„í—˜ë„ <span id="riskSortIcon">â–¼</span></th>
        <th style="width:120px">ì¶”ì²œ ì¡°ì¹˜</th>
        <th style="width:100px">ì¹´í…Œê³ ë¦¬</th>
        <th>ë¦¬ë·° ë‚´ìš©</th>
      </tr>
    </thead>
    <tbody>
      {% for row in recommended_responses %}
        <tr class="review-set" data-review-id="{{ row.id }}">
          <td>{{ row.date }}</td>
          <td>
            <span class="risk-chip {% if row.risk_score_norm >= 70 %}risk-high{% elif row.risk_score_norm >= 30 %}risk-medium{% else %}risk-low{% endif %}">
              {{ row.risk_score_norm }}
            </span>
          </td>
          <td>
            <span class="method-pill pill-{{ row.method }}">
              {{ method_labels[row.method] }}
            </span>
          </td>
          <td>{{ row.category }}</td>
          <td>{{ row.review_text }}</td>
        </tr>
        <tr class="review-keywords-row" data-review-id="{{ row.id }}">
          <td colspan="5">
            <span class="review-keywords" style="font-size:0.85em; color:#888; letter-spacing:0.03em;">
              {% if row.keywords %}
                ë¶ˆí‰ í‚¤ì›Œë“œ: {{ row.keywords | join(", ") }}
              {% else %}
                &nbsp;
              {% endif %}
            </span>
          </td>
        </tr>
        <tr class="review-reply-row" data-review-id="{{ row.id }}">
          <td colspan="5">
            <span class="review-keywords" style="font-style:italic; color:#3b3b3b;">
              AI ìë™ ë‹µë³€: {{ row.suggested_reply or '(ìë™ ë‹µë³€ ì—†ìŒ)' }}
            </span>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  <script>
    // ìœ„í—˜ë„ ì •ë ¬ (ì„¸íŠ¸ ë‹¨ìœ„)
    let riskAsc = false;
    const table = document.getElementById('recommendTable');
    const riskHeader = document.getElementById('riskSortHeader');
    const riskSortIcon = document.getElementById('riskSortIcon');
    riskHeader.addEventListener('click', function() {
      const tbody = table.tBodies[0];
      // ëª¨ë“  ë¦¬ë·° ì„¸íŠ¸ ì¶”ì¶œ
      const sets = [];
      const rows = Array.from(tbody.querySelectorAll('tr.review-set'));
      rows.forEach(row => {
        const reviewId = row.getAttribute('data-review-id');
        const setRows = [
          row,
          tbody.querySelector(`tr.review-keywords-row[data-review-id="${reviewId}"]`),
          tbody.querySelector(`tr.review-reply-row[data-review-id="${reviewId}"]`)
        ];
        sets.push(setRows);
      });
      // ìœ„í—˜ë„ ê¸°ì¤€ ì •ë ¬
      sets.sort((a, b) => {
        const riskA = parseFloat(a[0].querySelector('td:nth-child(2) span').innerText.trim()) || 0;
        const riskB = parseFloat(b[0].querySelector('td:nth-child(2) span').innerText.trim()) || 0;
        return riskAsc ? riskA - riskB : riskB - riskA;
      });
      riskAsc = !riskAsc;
      riskSortIcon.textContent = riskAsc ? 'â–²' : 'â–¼';
      sets.forEach(setRows => setRows.forEach(tr => tbody.appendChild(tr)));
    });
    // ë‚ ì§œ ì •ë ¬ (ì„¸íŠ¸ ë‹¨ìœ„)
    let dateAsc = false;
    const dateHeader = document.getElementById('dateSortHeader');
    const dateSortIcon = document.getElementById('dateSortIcon');
    dateHeader.addEventListener('click', function() {
      const tbody = table.tBodies[0];
      const sets = [];
      const rows = Array.from(tbody.querySelectorAll('tr.review-set'));
      rows.forEach(row => {
        const reviewId = row.getAttribute('data-review-id');
        const setRows = [
          row,
          tbody.querySelector(`tr.review-keywords-row[data-review-id="${reviewId}"]`),
          tbody.querySelector(`tr.review-reply-row[data-review-id="${reviewId}"]`)
        ];
        sets.push(setRows);
      });
      sets.sort((a, b) => {
        const dateA = new Date(a[0].querySelector('td').innerText.trim());
        const dateB = new Date(b[0].querySelector('td').innerText.trim());
        return dateAsc ? dateA - dateB : dateB - dateA;
      });
      dateAsc = !dateAsc;
      dateSortIcon.textContent = dateAsc ? 'â–²' : 'â–¼';
      sets.forEach(setRows => setRows.forEach(tr => tbody.appendChild(tr)));
    });
    // í•„í„°ë§ (ì„¸íŠ¸ ë‹¨ìœ„)
    // ëŒ€ì‘ë°©ë²•ë³„/ì¹´í…Œê³ ë¦¬ë³„ í•„í„°
    document.getElementById('methodFilter').addEventListener('change', filterTableSets);
    document.getElementById('categoryFilter').addEventListener('change', filterTableSets);
    document.getElementById('resetFiltersBtn').addEventListener('click', function() {
      document.getElementById('methodFilter').value = 'all';
      document.getElementById('categoryFilter').value = 'all';
      filterTableSets();
    });

    function filterTableSets() {
      const methodValue = document.getElementById('methodFilter').value;
      const categoryValue = document.getElementById('categoryFilter').value;
      const tbody = table.tBodies[0];
      const sets = [];
      const rows = Array.from(tbody.querySelectorAll('tr.review-set'));
      rows.forEach(row => {
        const reviewId = row.getAttribute('data-review-id');
        const setRows = [
          row,
          tbody.querySelector(`tr.review-keywords-row[data-review-id="${reviewId}"]`),
          tbody.querySelector(`tr.review-reply-row[data-review-id="${reviewId}"]`)
        ];
        sets.push(setRows);
      });
      sets.forEach(setRows => {
        const method = setRows[0].getAttribute('data-method');
        const category = setRows[0].querySelector('td:nth-child(4)').innerText.trim();
        const show = ( (methodValue === 'all' || method === methodValue) && (categoryValue === 'all' || category === categoryValue) );
        setRows.forEach(tr => tr.style.display = show ? '' : 'none');
      });
    }

    // ì›Œë“œí´ë¼ìš°ë“œ ìƒì„± (í‚¤ì›Œë“œ ì§‘ê³„)
    window.addEventListener('DOMContentLoaded', function() {
      const keywordSpans = document.querySelectorAll('.review-keywords-row .review-keywords');
      const keywordCounts = {};
      keywordSpans.forEach(span => {
        const text = span.textContent.replace('í‚¤ì›Œë“œ:', '').trim();
        if (!text) return;
        text.split(',').forEach(word => {
          const w = word.trim();
          if (!w) return;
          keywordCounts[w] = (keywordCounts[w]||0) + 1;
        });
      });
      const wordCloudList = Object.entries(keywordCounts).map(([word, count]) => [word, count*10+20]);
      if (wordCloudList.length > 0 && window.WordCloud) {
        // ë‹¤ì±„ë¡œìš´ ìƒ‰ìƒ íŒ”ë ˆíŠ¸
        const palette = ['#2ED47A', '#4B9EFF', '#F7B500', '#FF6B6B', '#8B54FF', '#FF9F1C', '#00B8A9', '#FF61A6', '#3B3B3B', '#FFB4A2'];
        WordCloud(document.getElementById('wordCloud'), {
          list: wordCloudList,
          gridSize: 14,
          weightFactor: 2.5,
          fontFamily: 'NanumSquare, sans-serif',
          color: function(word, weight, fontSize, distance, theta) {
            // ë‹¨ì–´ë³„ë¡œ íŒ”ë ˆíŠ¸ì—ì„œ ìˆœí™˜ ë˜ëŠ” ëœë¤ ìƒ‰ìƒ
            const idx = Math.abs(word.split('').reduce((a,c)=>a+c.charCodeAt(0),0)) % palette.length;
            return palette[idx];
          },
          backgroundColor: 'rgba(0,0,0,0)',
          rotateRatio: 0.2,
          minRotation: -0.2,
          maxRotation: 0.2,
          drawOutOfBound: false,
        });
      }
    });
  </script>
{% endif %}

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     E.  ì„¸ì¼ì¦ˆ ë°°ë„ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
{% if metrics %}
  <div class="banner">
    <h3>ë³„ì ì„ ì§€í‚¬ ì¤€ë¹„ ë˜ì…¨ë‚˜ìš”?</h3>
    <p>
      <strong>20 ë¶„ ë¬´ë£Œ ìƒë‹´</strong>ì„ ì˜ˆì•½í•˜ê³ <br>
      <b>ì¶”ê°€ 30 % í• ì¸ ì¿ í°</b>ë„ ë°›ì•„ê°€ì„¸ìš”!
    </p>
    <a href="https://cal.com/x-review-lab/20min-teardown" target="_blank"
       class="banner-btn">ìƒë‹´ ì˜ˆì•½í•˜ê¸° â†’</a>
  </div>
{% endif %}

{% endblock %}
