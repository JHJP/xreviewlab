{% extends "base.html" %}
{% block content %}

<div id="welcome-overlay" class="overlay" style="display:none">
  <div class="overlay-card">
    <h1>엑스 리뷰 랩에 오신 걸<br> 환영해요 👋</h1>
    <p>
      우리 서비스는 <strong>고객의 소리(VoC)</strong>가 <br>
      <strong>생산공정</strong>에 반영되는 효율을 높여줘요.<br>
      아래 버튼을 누르면 <strong>3분</strong> 만에 <strong>샘플</strong> 화면을 볼 수 있어요!
    </p>
    <button id="startTutorialBtn">시작하기</button>
  </div>
</div>

<h1>고객의 소리 대응 서포터</h1>
<p class="tagline">AI가 <strong>가장 중요한 고객의 소리</strong>부터 해결합니다.</p>

<div class="card">
  <form method="POST" enctype="multipart/form-data" id="plannerForm">
    <label for="brand_name">브랜드 이름을 입력하세요</label>
    <input type="text" name="brand_name" id="brand_name" placeholder="예: 토리든" required>
    <label for="brand_url">자사몰 URL을 입력하세요</label>
    <input type="text" name="brand_url" id="brand_url" placeholder="예: https://www.torriden.com/" required>
    <button type="button" id="vocListenBtn" style="margin-top:1em;">VoC 듣기</button>
    <div id="loading-spinner" style="display:none; text-align:center; margin-top:1em;">
      <div class="spinner" style="display:inline-block; width:40px; height:40px; border:4px solid #eee; border-top:4px solid #22b86b; border-radius:50%; animation:spin 1s linear infinite;"></div>
      <div style="margin-top:0.5em; color:#22b86b; font-weight:600;">상품 정보를 불러오는 중...</div>
    </div>
    <style>
      @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    </style>
    <script>
      document.getElementById('vocListenBtn').addEventListener('click', function() {
        document.getElementById('loading-spinner').style.display = '';
        const brandName = document.getElementById('brand_name').value;
        const brandUrl = document.getElementById('brand_url').value;
        fetch('/voc_listen', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ brand_name: brandName, brand_url: brandUrl })
        }).then(resp => {
          if (resp.redirected) {
            window.location.href = resp.url;
          } else {
            window.location.reload();
          }
        });
      });
    </script>
  </form>
</div>

{% if products %}
  <h2 style="margin:2rem 0 1rem;">상품별 VoC 요약</h2>
  <table class="voc-table" style="width:100%; border-collapse:collapse;">
    <thead>
      <tr style="background:#f2f2f2;">
        <th style="padding:0.7em; border:1px solid #ddd;">상품명</th>
        <th style="padding:0.7em; border:1px solid #ddd;">별점</th>
        <th style="padding:0.7em; border:1px solid #ddd;">위험수치</th>

      </tr>
    </thead>
    <tbody>
      {% for p in products %}
      <tr>
        <td style="padding:0.7em; border:1px solid #ddd;">
          {% set has_reviews = p.goodsNo is defined and p.goodsNo %}
          {% if has_reviews %}
            <a href="/product/{{ p.goodsNo }}/reviews" style="color:#2ED47A; font-weight:600; text-decoration:underline;">{{ p.name }}</a>
          {% else %}
            <span style="color:#bbb; cursor:not-allowed;">{{ p.name }}</span>
          {% endif %}
        </td>
        <td style="padding:0.7em; border:1px solid #ddd;">{{ p.rating }}</td>
        <td style="padding:0.7em; border:1px solid #ddd;">{{ p.damage_sum if p.damage_sum is not none else '-' }}</td>
      </tr>
      <tr>
        <td colspan="3" style="padding:0.5em 0.7em; border:1px solid #ddd; background:#f9f9f9; color:#666; font-size:0.96em;">
          <strong>상위 키워드:</strong>
          {% if p.top5_keywords and p.top5_keywords|length > 0 %}
            <span class="keyword-list">
              {% for kw in p.top5_keywords %}
                <a href="#" class="keyword-btn" data-goodsno="{{ p.goodsNo }}" data-keyword="{{ kw }}">{{ kw }}</a>{% if not loop.last %}, {% endif %}
              {% endfor %}
            </span>
          {% else %}
            -
          {% endif %}

          <!-- Modal for keyword editing/Q&A -->
          <div id="keyword-modal" class="modal" style="display:none;">
            <div class="modal-content">
              <span class="close" id="modal-close">&times;</span>
              <h3 id="modal-title">키워드 상세</h3>
              <div id="modal-gpt-area">
                <div style="margin-bottom:0.7em;">
                  <strong>키워드 의미 Q&A (GPT)</strong>
                </div>
                <div id="gpt-meaning" style="background:#f7f7fa; padding:0.8em; border-radius:7px; min-height:48px; margin-bottom:1em; color:#333;">불러오는 중...</div>
              </div>
              <form id="keyword-edit-form">
                <label>키워드 수정</label>
                <input type="text" id="edit-keyword" name="edit-keyword" style="width:100%; margin-bottom:1em;">
                <label>비용 (원)</label>
                <input type="number" id="edit-cost" name="edit-cost" style="width:100%; margin-bottom:1em;">
                <label>처리 시간 (시간)</label>
                <input type="number" id="edit-time" name="edit-time" style="width:100%; margin-bottom:1.2em;">
                <button type="submit" class="save-btn">저장</button>
              </form>
            </div>
          </div>
          <style>
            .modal { position:fixed; z-index:1001; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.28); display:flex; align-items:center; justify-content:center; }
            .modal-content { background:#fff; padding:2.2em 2.2em 1.2em; border-radius:12px; max-width:410px; width:96vw; box-shadow:0 8px 32px rgba(0,0,0,0.18); position:relative; }
            .close { position:absolute; right:1.1em; top:1.1em; font-size:1.6em; color:#aaa; cursor:pointer; }
            .save-btn { background:#2ED47A; color:#fff; border:none; padding:0.7em 1.7em; border-radius:7px; font-size:1.1em; cursor:pointer; margin-top:0.5em; }
            .save-btn:hover { background:#21a15a; }
            .keyword-btn { color:#4B9EFF; text-decoration:underline; cursor:pointer; margin-right:0.2em; }
            .keyword-btn:hover { color:#2ED47A; }
          </style>
          <script>
          document.addEventListener('DOMContentLoaded', function() {
            let modal = document.getElementById('keyword-modal');
            let modalClose = document.getElementById('modal-close');
            let gptMeaning = document.getElementById('gpt-meaning');
            let modalTitle = document.getElementById('modal-title');
            let editKeyword = document.getElementById('edit-keyword');
            let editCost = document.getElementById('edit-cost');
            let editTime = document.getElementById('edit-time');
            let editForm = document.getElementById('keyword-edit-form');
            let currentGoodsNo = null;
            let currentKeyword = null;

            document.querySelectorAll('.keyword-btn').forEach(btn => {
              btn.addEventListener('click', function(e) {
                e.preventDefault();
                currentGoodsNo = btn.dataset.goodsno;
                currentKeyword = btn.dataset.keyword;
                modalTitle.textContent = `키워드 상세: "${currentKeyword}"`;
                editKeyword.value = currentKeyword;
                // Fetch cost/time first
                fetch(`/product/${currentGoodsNo}/keyword/${encodeURIComponent(currentKeyword)}`)
                  .then(r => r.json())
                  .then(data => {
                    editCost.value = (data.cost !== undefined && data.cost !== null && data.cost !== '') ? data.cost : '';
                    editTime.value = (data.time !== undefined && data.time !== null && data.time !== '') ? data.time : ((data.processing_time !== undefined && data.processing_time !== null && data.processing_time !== '') ? data.processing_time : '');
                  });
                // Fetch meaning separately
                gptMeaning.textContent = '불러오는 중...';
                fetch(`/product/${currentGoodsNo}/keyword/${encodeURIComponent(currentKeyword)}/meaning`)
                  .then(r => r.json())
                  .then(data => {
                    gptMeaning.textContent = data.meaning || '-';
                  })
                  .catch(() => {
                    gptMeaning.textContent = '에러: 정보를 불러올 수 없습니다.';
                  });
                modal.style.display = 'flex';
              });
            });
            modalClose.onclick = ()=>{ modal.style.display='none'; };
            window.onclick = (e)=>{ if(e.target==modal) modal.style.display='none'; };
            editForm.onsubmit = function(e){
              e.preventDefault();
              const newKeyword = editKeyword.value.trim();
              const cost = editCost.value.trim();
              const time = editTime.value.trim();
              if(!newKeyword) { alert('키워드를 입력하세요.'); return; }
              fetch(`/product/${currentGoodsNo}/keyword/${encodeURIComponent(currentKeyword)}`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({ new_keyword:newKeyword, cost, time })
              })
              .then(r=>r.json())
              .then(data=>{
                if(data.success){
                  alert('저장되었습니다!');
                  modal.style.display='none';
                  window.location.reload();
                }else{
                  alert('저장 실패: '+(data.error||''));
                }
              });
            };
          });
          </script>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}

<!-- ────────────────────────────────────────────────
     D.  추천 액션 테이블
──────────────────────────────────────────────────── -->
{% if recommended_responses %}
  <!-- 워드클라우드 안내 및 표시 -->
  <div style="margin-top:2.2rem; margin-bottom:0.2rem;">
    <div style="font-size:0.97em; color:#666; margin-bottom:0.35em; text-align:center;">
      아래 워드클라우드는 최근 리뷰에서 자주 언급된 주요 키워드를 시각화한 것입니다.<br>
      단어가 클수록 더 많이 언급된 의미입니다.
    </div>
    <div id="wordCloud" style="width:100%; height:260px; margin-bottom:1.4rem;"></div>
  </div>
  <h2 style="margin-top:1.3rem;">추천 조치</h2>
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem; gap:1.5em;">
    <a href="/download_report" class="banner-btn" style="padding:0.5em 1.2em; font-size:0.98em;">리포트 다운로드 (엑셀)</a>
    <form id="emailReportForm" method="POST" action="/send_report_email" style="display:flex; align-items:center; gap:0.5em;">
      <input type="email" name="email" placeholder="이메일 입력" required style="padding:0.45em 0.8em; border-radius:7px; border:1px solid #ccc; font-size:0.97em;">
      <button type="submit" class="banner-btn" style="padding:0.5em 1.2em; font-size:0.98em; background:#2ED47A;">이메일로 리포트 발송</button>
    </form>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
  <script>
    document.getElementById('emailReportForm').onsubmit = async function(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const res = await fetch(form.action, {
        method: 'POST',
        body: formData
      });
      const text = await res.text();
      alert(text);
    };
    const table = document.getElementById('recommendTable');
    let dateAsc = false, riskAsc = false;
    document.getElementById('dateSortHeader').addEventListener('click', function() {
      const tbody = table.tBodies[0];
      const rows = Array.from(tbody.querySelectorAll('tr.review-set'));
      const sets = rows.map(row => [row,
        tbody.querySelector(`tr.review-keywords-row[data-review-id="${row.getAttribute('data-review-id')}"]`),
        tbody.querySelector(`tr.review-reply-row[data-review-id="${row.getAttribute('data-review-id')}"]`)
      ]);
      sets.sort((a, b) => {
        const d1 = a[0].children[0].textContent, d2 = b[0].children[0].textContent;
        return dateAsc ? d1.localeCompare(d2) : d2.localeCompare(d1);
      });
      sets.forEach(setRows => setRows.forEach(tr => tbody.appendChild(tr)));
      dateAsc = !dateAsc;
      document.getElementById('dateSortIcon').textContent = dateAsc ? '▲' : '▼';
    });
    document.getElementById('riskSortHeader').addEventListener('click', function() {
      const tbody = table.tBodies[0];
      const rows = Array.from(tbody.querySelectorAll('tr.review-set'));
      const sets = rows.map(row => [row,
        tbody.querySelector(`tr.review-keywords-row[data-review-id="${row.getAttribute('data-review-id')}"]`),
        tbody.querySelector(`tr.review-reply-row[data-review-id="${row.getAttribute('data-review-id')}"]`)
      ]);
      sets.sort((a, b) => {
        const r1 = a[0].children[1].textContent, r2 = b[0].children[1].textContent;
        return riskAsc ? r1.localeCompare(r2) : r2.localeCompare(r1);
      });
      sets.forEach(setRows => setRows.forEach(tr => tbody.appendChild(tr)));
      riskAsc = !riskAsc;
      document.getElementById('riskSortIcon').textContent = riskAsc ? '▲' : '▼';
    });
    document.getElementById('methodFilter').addEventListener('change', filterTableSets);
    document.getElementById('categoryFilter').addEventListener('change', filterTableSets);
    document.getElementById('resetFiltersBtn').addEventListener('click', function() {
      document.getElementById('methodFilter').value = 'all';
      document.getElementById('categoryFilter').value = 'all';
      filterTableSets();
    });
    function filterTableSets() {
      const methodValue = document.getElementById('methodFilter').value;
      const categoryValue = document.getElementById('categoryFilter').value;
      const tbody = table.tBodies[0];
      const sets = [];
      const rows = Array.from(tbody.querySelectorAll('tr.review-set'));
      rows.forEach(row => {
        const reviewId = row.getAttribute('data-review-id');
        const setRows = [
          row,
          tbody.querySelector(`tr.review-keywords-row[data-review-id="${reviewId}"]`),
          tbody.querySelector(`tr.review-reply-row[data-review-id="${reviewId}"]`)
        ];
        sets.push(setRows);
      });
      sets.forEach(setRows => {
        const method = setRows[0].getAttribute('data-method');
        const category = setRows[0].querySelector('td:nth-child(4)').innerText.trim();
        const show = ( (methodValue === 'all' || method === methodValue) && (categoryValue === 'all' || category === categoryValue) );
        setRows.forEach(tr => tr.style.display = show ? '' : 'none');
      });
    }
    window.addEventListener('DOMContentLoaded', function() {
      const keywordSpans = document.querySelectorAll('.review-keywords-row .review-keywords');
      const keywordCounts = {};
      keywordSpans.forEach(span => {
        const text = span.textContent.replace('키워드:', '').trim();
        if (!text) return;
        text.split(',').forEach(word => {
          const w = word.trim();
          if (!w) return;
          keywordCounts[w] = (keywordCounts[w]||0) + 1;
        });
      });
      const wordCloudList = Object.entries(keywordCounts).map(([word, count]) => [word, count*10+20]);
      if (wordCloudList.length > 0 && window.WordCloud) {
        const palette = ['#2ED47A', '#4B9EFF', '#F7B500', '#FF6B6B', '#8B54FF', '#FF9F1C', '#00B8A9', '#FF61A6', '#3B3B3B', '#FFB4A2'];
        WordCloud(document.getElementById('wordCloud'), {
          list: wordCloudList,
          gridSize: 14,
          weightFactor: 2.5,
          fontFamily: 'NanumSquare, sans-serif',
          color: function(word, weight, fontSize, distance, theta) {
            const idx = Math.abs(word.split('').reduce((a,c)=>a+c.charCodeAt(0),0)) % palette.length;
            return palette[idx];
          },
          backgroundColor: 'rgba(0,0,0,0)',
          rotateRatio: 0.2,
          minRotation: -0.2,
          maxRotation: 0.2,
          drawOutOfBound: false,
        });
      }
    });
  </script>
{% endif %}

{% if metrics %}
  <div class="banner">
    <h3>별점을 지킬 준비 되셨나요?</h3>
    <p>
      <strong>20 분 무료 상담</strong>을 예약하고<br>
      <b>추가 30 % 할인 쿠폰</b>도 받아가세요!
    </p>
    <a href="https://cal.com/x-review-lab/20min-teardown" target="_blank" class="banner-btn">상담 예약하기 →</a>
  </div>
{% endif %}

<script>
// welcome-overlay: only show on first visit
(function() {
  const overlay = document.getElementById('welcome-overlay');
  const startBtn = document.getElementById('startTutorialBtn');
  if (localStorage.getItem('xrl_welcome_shown') === 'yes') {
    overlay.style.display = 'none';
  } else {
    overlay.style.display = '';
  }
  startBtn.addEventListener('click', function() {
    localStorage.setItem('xrl_welcome_shown', 'yes');
    overlay.style.display = 'none';
  });
})();
</script>
{% endblock %}
